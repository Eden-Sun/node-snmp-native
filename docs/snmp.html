<!DOCTYPE html>  <html> <head>   <title>snmp.js</title>   <meta http-equiv="content-type" content="text/html; charset=UTF-8">   <link rel="stylesheet" media="all" href="docco.css" /> </head> <body>   <div id="container">     <div id="background"></div>            <div id="jump_to">         Jump To &hellip;         <div id="jump_wrapper">           <div id="jump_page">                                           <a class="source" href="asn1ber.html">                 asn1ber.js               </a>                                           <a class="source" href="snmp.html">                 snmp.js               </a>                        </div>         </div>       </div>          <table cellpadding="0" cellspacing="0">       <thead>         <tr>           <th class="docs">             <h1>               snmp.js             </h1>           </th>           <th class="code">           </th>         </tr>       </thead>       <tbody>                               <tr id="section-1">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-1">&#182;</a>               </div>               <p>This file implements a structure representing an SNMP message
and routines for converting to and from the network representation.</p>

<p>(c) 2012 Jakob Borg, Nym Networks</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="kd">var</span> <span class="nx">_</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;underscore&#39;</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">asn1ber</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;./asn1ber&#39;</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">assert</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;assert&#39;</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-2">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-2">&#182;</a>               </div>               <h2>Basic structures</h2>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-3">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-3">&#182;</a>               </div>               <p>A <code>VarBind</code> is the innermost structure, containing an OID-Value pair.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="kd">function</span> <span class="nx">VarBind</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">encodeOid</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">type</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">value</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
<span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-4">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-4">&#182;</a>               </div>               <p>The <code>PDU</code> contains the SNMP request or response fields and a list of <code>VarBinds</code>.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="kd">function</span> <span class="nx">PDU</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">type</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">reqid</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">error</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">errorIndex</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">varbinds</span> <span class="o">=</span> <span class="p">[</span> <span class="k">new</span> <span class="nx">VarBind</span><span class="p">()</span> <span class="p">];</span>
<span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-5">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-5">&#182;</a>               </div>               <p>The <code>Packet</code> contains the SNMP version and community and the <code>PDU</code>.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="kd">function</span> <span class="nx">Packet</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">version</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">community</span> <span class="o">=</span> <span class="s1">&#39;public&#39;</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">pdu</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">PDU</span><span class="p">();</span>
<span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-6">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-6">&#182;</a>               </div>               <p>Allow consumers to create packet structures from scratch.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">exports</span><span class="p">.</span><span class="nx">Packet</span> <span class="o">=</span> <span class="nx">Packet</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-7">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-7">&#182;</a>               </div>               <h2>Private helper functions</h2>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-8">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-8">&#182;</a>               </div>               <p>Concatenate several buffers to one.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="kd">function</span> <span class="nx">concatBuffers</span><span class="p">(</span><span class="nx">buffers</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">total</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">cur</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-9">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-9">&#182;</a>               </div>               <p>First we calculate the total length,</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">_</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span><span class="nx">buffers</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">buffer</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">total</span> <span class="o">+=</span> <span class="nx">buffer</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
    <span class="p">});</span></pre></div>             </td>           </tr>                               <tr id="section-10">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-10">&#182;</a>               </div>               <p>then we allocate a new Buffer large enough to contain all data,</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="kd">var</span> <span class="nx">buf</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Buffer</span><span class="p">(</span><span class="nx">total</span><span class="p">);</span>
    <span class="nx">_</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span><span class="nx">buffers</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">buffer</span><span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-11">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-11">&#182;</a>               </div>               <p>finally we copy the data into the new larger buffer.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">buffer</span><span class="p">.</span><span class="nx">copy</span><span class="p">(</span><span class="nx">buf</span><span class="p">,</span> <span class="nx">cur</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
        <span class="nx">cur</span> <span class="o">+=</span> <span class="nx">buffer</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
    <span class="p">});</span>

    <span class="k">return</span> <span class="nx">buf</span><span class="p">;</span>
<span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-12">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-12">&#182;</a>               </div>               <h2>Encode structure to ASN.1 BER</h2>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-13">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-13">&#182;</a>               </div>               <p>Return an ASN.1 BER encoding of a Packet structure.
This is suitable for transmission on a UDP socket.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">exports</span><span class="p">.</span><span class="nx">encode</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">pkt</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">version</span><span class="p">,</span> <span class="nx">community</span><span class="p">,</span> <span class="nx">reqid</span><span class="p">,</span> <span class="nx">err</span><span class="p">,</span> <span class="nx">erridx</span><span class="p">,</span> <span class="nx">vbs</span><span class="p">,</span> <span class="nx">pdu</span><span class="p">,</span> <span class="nx">message</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-14">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-14">&#182;</a>               </div>               <p>We only support SNMPv2c, so enforce that version stamp.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">if</span> <span class="p">(</span><span class="nx">pkt</span><span class="p">.</span><span class="nx">version</span> <span class="o">!==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">&#39;Only SNMPv2c is supported.&#39;</span><span class="p">);</span>
    <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-15">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-15">&#182;</a>               </div>               <p>Encode the message header fields.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">version</span> <span class="o">=</span> <span class="nx">asn1ber</span><span class="p">.</span><span class="nx">encodeInteger</span><span class="p">(</span><span class="nx">pkt</span><span class="p">.</span><span class="nx">version</span><span class="p">);</span>
    <span class="nx">community</span> <span class="o">=</span> <span class="nx">asn1ber</span><span class="p">.</span><span class="nx">encodeOctetString</span><span class="p">(</span><span class="nx">pkt</span><span class="p">.</span><span class="nx">community</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-16">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-16">&#182;</a>               </div>               <p>Encode the PDU header fields.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">reqid</span> <span class="o">=</span> <span class="nx">asn1ber</span><span class="p">.</span><span class="nx">encodeInteger</span><span class="p">(</span><span class="nx">pkt</span><span class="p">.</span><span class="nx">pdu</span><span class="p">.</span><span class="nx">reqid</span><span class="p">);</span>
    <span class="nx">err</span> <span class="o">=</span> <span class="nx">asn1ber</span><span class="p">.</span><span class="nx">encodeInteger</span><span class="p">(</span><span class="nx">pkt</span><span class="p">.</span><span class="nx">pdu</span><span class="p">.</span><span class="nx">error</span><span class="p">);</span>
    <span class="nx">erridx</span> <span class="o">=</span> <span class="nx">asn1ber</span><span class="p">.</span><span class="nx">encodeInteger</span><span class="p">(</span><span class="nx">pkt</span><span class="p">.</span><span class="nx">pdu</span><span class="p">.</span><span class="nx">errorIndex</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-17">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-17">&#182;</a>               </div>               <p>Encode the PDU varbinds.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">vbs</span> <span class="o">=</span> <span class="p">[];</span>
    <span class="nx">_</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span><span class="nx">pkt</span><span class="p">.</span><span class="nx">pdu</span><span class="p">.</span><span class="nx">varbinds</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">vb</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">oid</span> <span class="o">=</span> <span class="nx">asn1ber</span><span class="p">.</span><span class="nx">encodeOid</span><span class="p">(</span><span class="nx">vb</span><span class="p">.</span><span class="nx">oid</span><span class="p">);</span>
        <span class="kd">var</span> <span class="nx">val</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">vb</span><span class="p">.</span><span class="nx">type</span> <span class="o">===</span> <span class="nx">asn1ber</span><span class="p">.</span><span class="nx">types</span><span class="p">.</span><span class="nx">Null</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">val</span> <span class="o">=</span> <span class="nx">asn1ber</span><span class="p">.</span><span class="nx">encodeNull</span><span class="p">();</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">&#39;Unknown varbind type &quot;&#39;</span> <span class="o">+</span> <span class="nx">vb</span><span class="p">.</span><span class="nx">type</span> <span class="o">+</span> <span class="s1">&#39;&quot; in encoding.&#39;</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="nx">vbs</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">asn1ber</span><span class="p">.</span><span class="nx">encodeSequence</span><span class="p">(</span><span class="nx">concatBuffers</span><span class="p">([</span><span class="nx">oid</span><span class="p">,</span> <span class="nx">val</span><span class="p">])));</span>
    <span class="p">});</span></pre></div>             </td>           </tr>                               <tr id="section-18">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-18">&#182;</a>               </div>               <p>Concatenate all the varbinds together.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">vbs</span> <span class="o">=</span> <span class="nx">asn1ber</span><span class="p">.</span><span class="nx">encodeSequence</span><span class="p">(</span><span class="nx">concatBuffers</span><span class="p">(</span><span class="nx">vbs</span><span class="p">));</span></pre></div>             </td>           </tr>                               <tr id="section-19">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-19">&#182;</a>               </div>               <p>Create the PDU by concatenating the inner fields and adding a request structure around it.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">pdu</span> <span class="o">=</span> <span class="nx">asn1ber</span><span class="p">.</span><span class="nx">encodeRequest</span><span class="p">(</span><span class="nx">pkt</span><span class="p">.</span><span class="nx">pdu</span><span class="p">.</span><span class="nx">type</span><span class="p">,</span> <span class="nx">concatBuffers</span><span class="p">([</span><span class="nx">reqid</span><span class="p">,</span> <span class="nx">err</span><span class="p">,</span> <span class="nx">erridx</span><span class="p">,</span> <span class="nx">vbs</span><span class="p">]));</span></pre></div>             </td>           </tr>                               <tr id="section-20">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-20">&#182;</a>               </div>               <p>Create the message by concatenating the header fields and the PDU.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">message</span> <span class="o">=</span> <span class="nx">asn1ber</span><span class="p">.</span><span class="nx">encodeSequence</span><span class="p">(</span><span class="nx">concatBuffers</span><span class="p">([</span><span class="nx">version</span><span class="p">,</span> <span class="nx">community</span><span class="p">,</span> <span class="nx">pdu</span><span class="p">]));</span>

    <span class="k">return</span> <span class="nx">message</span><span class="p">;</span>
<span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-21">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-21">&#182;</a>               </div>               <h2>Parse ASN.1 BER into a structure</h2>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-22">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-22">&#182;</a>               </div>               <p>Parse an SNMP packet into its component fields.
We don't do a lot of validation so a malformed packet will probably just
make us blow up.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">exports</span><span class="p">.</span><span class="nx">parse</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">buf</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">pkt</span><span class="p">,</span> <span class="nx">oid</span><span class="p">,</span> <span class="nx">bvb</span><span class="p">,</span> <span class="nx">vb</span><span class="p">;</span>

    <span class="nx">pkt</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Packet</span><span class="p">();</span></pre></div>             </td>           </tr>                               <tr id="section-23">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-23">&#182;</a>               </div>               <p>First we have a sequence marker (two bytes).
We don't care about those, so cut them off.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">assert</span><span class="p">.</span><span class="nx">equal</span><span class="p">(</span><span class="nx">asn1ber</span><span class="p">.</span><span class="nx">types</span><span class="p">.</span><span class="nx">Sequence</span><span class="p">,</span> <span class="nx">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
    <span class="nx">buf</span> <span class="o">=</span> <span class="nx">buf</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-24">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-24">&#182;</a>               </div>               <p>Then comes the version field (integer). Parse it and slice it.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">pkt</span><span class="p">.</span><span class="nx">version</span> <span class="o">=</span> <span class="nx">asn1ber</span><span class="p">.</span><span class="nx">parseInteger</span><span class="p">(</span><span class="nx">buf</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">2</span><span class="p">));</span>
    <span class="nx">buf</span> <span class="o">=</span> <span class="nx">buf</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">2</span> <span class="o">+</span> <span class="nx">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span></pre></div>             </td>           </tr>                               <tr id="section-25">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-25">&#182;</a>               </div>               <p>We then get the community. Parse and slice.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">pkt</span><span class="p">.</span><span class="nx">community</span> <span class="o">=</span> <span class="nx">asn1ber</span><span class="p">.</span><span class="nx">parseOctetString</span><span class="p">(</span><span class="nx">buf</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">2</span><span class="p">));</span>
    <span class="nx">buf</span> <span class="o">=</span> <span class="nx">buf</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">2</span> <span class="o">+</span> <span class="nx">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span></pre></div>             </td>           </tr>                               <tr id="section-26">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-26">&#182;</a>               </div>               <p>Here's the PDU structure. We're interested in the type. Slice the rest.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">assert</span><span class="p">.</span><span class="nx">ok</span><span class="p">(</span><span class="nx">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mh">0xA0</span><span class="p">);</span>
    <span class="nx">pkt</span><span class="p">.</span><span class="nx">pdu</span><span class="p">.</span><span class="nx">type</span> <span class="o">=</span> <span class="nx">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mh">0xA0</span><span class="p">;</span>
    <span class="nx">buf</span> <span class="o">=</span> <span class="nx">buf</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-27">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-27">&#182;</a>               </div>               <p>The request id field.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">pkt</span><span class="p">.</span><span class="nx">pdu</span><span class="p">.</span><span class="nx">reqid</span> <span class="o">=</span> <span class="nx">asn1ber</span><span class="p">.</span><span class="nx">parseInteger</span><span class="p">(</span><span class="nx">buf</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">2</span><span class="p">));</span>
    <span class="nx">buf</span> <span class="o">=</span> <span class="nx">buf</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">2</span> <span class="o">+</span> <span class="nx">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span></pre></div>             </td>           </tr>                               <tr id="section-28">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-28">&#182;</a>               </div>               <p>The error field.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">pkt</span><span class="p">.</span><span class="nx">pdu</span><span class="p">.</span><span class="nx">error</span> <span class="o">=</span> <span class="nx">asn1ber</span><span class="p">.</span><span class="nx">parseInteger</span><span class="p">(</span><span class="nx">buf</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">2</span><span class="p">));</span>
    <span class="nx">buf</span> <span class="o">=</span> <span class="nx">buf</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">2</span> <span class="o">+</span> <span class="nx">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span></pre></div>             </td>           </tr>                               <tr id="section-29">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-29">&#182;</a>               </div>               <p>The error index field.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">pkt</span><span class="p">.</span><span class="nx">pdu</span><span class="p">.</span><span class="nx">errorIndex</span> <span class="o">=</span> <span class="nx">asn1ber</span><span class="p">.</span><span class="nx">parseInteger</span><span class="p">(</span><span class="nx">buf</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">2</span><span class="p">));</span>
    <span class="nx">buf</span> <span class="o">=</span> <span class="nx">buf</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">2</span> <span class="o">+</span> <span class="nx">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span></pre></div>             </td>           </tr>                               <tr id="section-30">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-30">&#182;</a>               </div>               <p>Here's the varbind list. Not interested.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">assert</span><span class="p">.</span><span class="nx">equal</span><span class="p">(</span><span class="nx">asn1ber</span><span class="p">.</span><span class="nx">types</span><span class="p">.</span><span class="nx">Sequence</span><span class="p">,</span> <span class="nx">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
    <span class="nx">buf</span> <span class="o">=</span> <span class="nx">buf</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-31">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-31">&#182;</a>               </div>               <p>Now comes the varbinds. There might be many, so we loop for as long as we have data.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">pkt</span><span class="p">.</span><span class="nx">pdu</span><span class="p">.</span><span class="nx">varbinds</span> <span class="o">=</span> <span class="p">[];</span>
    <span class="k">while</span> <span class="p">(</span><span class="nx">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="nx">asn1ber</span><span class="p">.</span><span class="nx">types</span><span class="p">.</span><span class="nx">Sequence</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">vb</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">VarBind</span><span class="p">();</span></pre></div>             </td>           </tr>                               <tr id="section-32">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-32">&#182;</a>               </div>               <p>The OID</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">bvb</span> <span class="o">=</span> <span class="nx">buf</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
        <span class="nx">vb</span><span class="p">.</span><span class="nx">oid</span> <span class="o">=</span> <span class="nx">asn1ber</span><span class="p">.</span><span class="nx">parseOid</span><span class="p">(</span><span class="nx">bvb</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-33">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-33">&#182;</a>               </div>               <p>The value</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">bvb</span> <span class="o">=</span> <span class="nx">bvb</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">2</span> <span class="o">+</span> <span class="nx">bvb</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
        <span class="nx">vb</span><span class="p">.</span><span class="nx">type</span> <span class="o">=</span> <span class="nx">bvb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">vb</span><span class="p">.</span><span class="nx">type</span> <span class="o">===</span> <span class="nx">asn1ber</span><span class="p">.</span><span class="nx">types</span><span class="p">.</span><span class="nx">Null</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">vb</span><span class="p">.</span><span class="nx">value</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">vb</span><span class="p">.</span><span class="nx">type</span> <span class="o">===</span> <span class="nx">asn1ber</span><span class="p">.</span><span class="nx">types</span><span class="p">.</span><span class="nx">OctetString</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">vb</span><span class="p">.</span><span class="nx">value</span> <span class="o">=</span> <span class="nx">asn1ber</span><span class="p">.</span><span class="nx">parseOctetString</span><span class="p">(</span><span class="nx">bvb</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">vb</span><span class="p">.</span><span class="nx">type</span> <span class="o">===</span> <span class="nx">asn1ber</span><span class="p">.</span><span class="nx">types</span><span class="p">.</span><span class="nx">Integer</span> <span class="o">||</span>
                   <span class="nx">vb</span><span class="p">.</span><span class="nx">type</span> <span class="o">==</span> <span class="nx">asn1ber</span><span class="p">.</span><span class="nx">types</span><span class="p">.</span><span class="nx">Counter</span> <span class="o">||</span>
                       <span class="nx">vb</span><span class="p">.</span><span class="nx">type</span> <span class="o">===</span> <span class="nx">asn1ber</span><span class="p">.</span><span class="nx">types</span><span class="p">.</span><span class="nx">Counter64</span> <span class="o">||</span>
                       <span class="nx">vb</span><span class="p">.</span><span class="nx">type</span> <span class="o">===</span> <span class="nx">asn1ber</span><span class="p">.</span><span class="nx">types</span><span class="p">.</span><span class="nx">TimeTicks</span> <span class="o">||</span>
                       <span class="nx">vb</span><span class="p">.</span><span class="nx">type</span> <span class="o">===</span> <span class="nx">asn1ber</span><span class="p">.</span><span class="nx">types</span><span class="p">.</span><span class="nx">Gauge</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">vb</span><span class="p">.</span><span class="nx">value</span> <span class="o">=</span> <span class="nx">asn1ber</span><span class="p">.</span><span class="nx">parseInteger</span><span class="p">(</span><span class="nx">bvb</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">&#39;Unrecognized value type &#39;</span> <span class="o">+</span> <span class="nx">vb</span><span class="p">.</span><span class="nx">type</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="nx">pkt</span><span class="p">.</span><span class="nx">pdu</span><span class="p">.</span><span class="nx">varbinds</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">vb</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-34">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-34">&#182;</a>               </div>               <p>Next varbind, if any</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">buf</span> <span class="o">=</span> <span class="nx">buf</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">2</span> <span class="o">+</span> <span class="nx">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
    <span class="p">};</span>

    <span class="k">return</span> <span class="nx">pkt</span><span class="p">;</span>
<span class="p">};</span>

</pre></div>             </td>           </tr>                </tbody>     </table>   </div> </body> </html> 